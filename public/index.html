<html>
    <head>
        <title>
            frontend
        </title>
    </head>
    <body>
        <script src="//unpkg.com/mithril/mithril.js"></script>
        <script src="/primus/primus.js"></script>
        <script>
            const createWorld = function(worldName, cb) {
                m.request({
                    method: 'PUT',
                    url: '/world',
                    data: {
                        name: worldName
                    },
                    headers: {
                        secret: window.localStorage.getItem('secret')
                    }
                })
                .then(function(result) {
                    cb();
                })
                .catch(function() {
                    cb();
                })
            };

            const updateSecret = function(cb) {
                const secret = window.localStorage.getItem('secret');

                m.request({
                    method: 'GET',
                    url: '/account',
                    headers: {
                        secret: secret
                    }
                })
                .then(function(result) {
                    cb();
                })
                .catch(function() {
                    const newSecret = 'S' + Math.random();

                    m.request({
                        method: 'PUT',
                        url: '/account',
                        data: {
                            secret: newSecret,
                            username: 'string' + Math.random()
                        }
                    })
                    .then(function(result) {
                        window.localStorage.setItem('secret', newSecret);
                        cb();
                    });
                })
            };

            const increaseScore = function() {
                const score = state.score && state.score.amount ? state.score.amount : 0;
                setKey('score', { amount: score + 1 })
            }

            const App = {
                view: function() {
                    const secret = window.localStorage.getItem('secret');

                    const score = state.score && state.score.amount ? state.score.amount : 0;

                    return m('div', [
                        m('h1', {}, 'App ' + secret),
                        m('div', score),
                        m('div', {
                            onclick: function() {
                                increaseScore();
                            }
                        }, '+'),
                        m('div', [
                            m('div', { onclick: function() {
                                setWorld('w1');
                                location.reload();
                            } }, 'w1'),
                            m('div', { onclick: function() {
                                setWorld('w2');
                                location.reload();
                            } }, 'w2')
                        ])
                    ]);
                }
            }

            const setWorld = function(world) {
                window.localStorage.setItem('world', world);
            }
            const getWorld = function() {
                return window.localStorage.getItem('world');
            }

            const setKey = function(key, value) {
                const secret = window.localStorage.getItem('secret');
                const world = getWorld();

                m.request({
                    method: 'PUT',
                    url: '/world/:world/value/:key',
                    headers: {
                        secret: secret
                    },
                    data: {
                        world: world,
                        key: key,
                        value: value
                    }
                })
                .then(function(result) {
                    window.primus.write({action: 'update', world: world, key: key});
                });
            }

            let state = {};

            const reloadData = function() {
                const secret = window.localStorage.getItem('secret');
                const world = getWorld();

                m.request({
                    method: 'GET',
                    url: '/world/:world/values',
                    headers: {
                        secret: secret
                    },
                    data: {
                        world: world
                    }
                })
                .then(function(result) {
                    const newState = {};
                    result.values.forEach(function(entry) {
                        newState[entry.key] = entry.value;
                    });
                    state = newState;
                    m.redraw();
                });
            }

            updateSecret(function() {
                const world = getWorld() || 'w1';
                setWorld(world);

                createWorld(world, function() {
                    window.primus = Primus.connect('/primus?secret='+window.localStorage.getItem('secret'));
                    window.primus.on('data', function(message) {
                        if (message.action === 'update' || message.action === 'delete') {
                            console.log('need to update');
                            reloadData();
                        }
                    });

                    window.primus.write({action: 'world', world: world});

                    m.route(document.body, '/', {
                        '/': App
                    })

                    reloadData();
                });
            });
        </script>
    </body>
</html>
